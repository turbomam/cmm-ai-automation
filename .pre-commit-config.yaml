---
# https://pre-commit.com/
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: check-toml
      - id: check-yaml
        args: [--unsafe]  # mkdocs.yml uses Python tags
      - id: check-json
      - id: pretty-format-json
        args: [--autofix, --indent=2]
        exclude: |
          (?x)^(
            \.vscode/.*|
            data/.*
          )$
      - id: end-of-file-fixer
        exclude: ^data/
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: ^data/

  - repo: https://github.com/adrienverge/yamllint.git
    rev: v1.37.0
    hooks:
      - id: yamllint
        args: [-c=.yamllint.yaml]

  - repo: https://github.com/codespell-project/codespell
    rev: v2.4.1
    hooks:
      - id: codespell
        additional_dependencies:
          - tomli
        exclude: ^data/

  - repo: https://github.com/crate-ci/typos
    rev: v1.31.1
    hooks:
      - id: typos
        exclude: ^data/

  - repo: https://github.com/astral-sh/ruff-pre-commit
    # Ruff version.
    rev: v0.11.3
    hooks:
      # Run the linter.
      - id: ruff
        args: [--fix, --exit-non-zero-on-fix]
      # Run the formatter.
      - id: ruff-format

  - repo: https://github.com/astral-sh/uv-pre-commit
    # uv version.
    rev: 0.6.12
    hooks:
      - id: uv-lock

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.13.0
    hooks:
      - id: mypy
        additional_dependencies:
          - pandas-stubs
          - types-requests
          - types-PyYAML
        exclude: |
          (?x)^(
            project/.*|
            src/cmm_ai_automation/datamodel/.*|
            src/cmm_ai_automation/scripts/extract_edge_patterns\.py|
            src/cmm_ai_automation/scripts/analyze_kgx_patterns\.py|
            src/cmm_ai_automation/scripts/index_.*\.py
          )$

  - repo: https://github.com/PyCQA/bandit
    rev: 1.8.3
    hooks:
      - id: bandit
        args: [-c, pyproject.toml]
        additional_dependencies: ["bandit[toml]"]
        exclude: |
          (?x)^(
            tests/.*|
            project/.*|
            src/cmm_ai_automation/datamodel/.*
          )$

  - repo: local
    hooks:
      - id: pip-audit
        name: pip-audit (vulnerability scanner)
        # Ignore CVE-2025-53000 (nbconvert) and CVE-2026-0994 (protobuf) - no fixes available yet
        entry: uv run pip-audit --ignore-vuln CVE-2025-53000 --ignore-vuln CVE-2026-0994
        language: system
        pass_filenames: false
        always_run: true

  - repo: https://github.com/fpgmaas/deptry
    rev: 0.21.1
    hooks:
      - id: deptry
        args: [src]
        pass_filenames: false  # scan entire src/ to avoid partial analysis

  # ==========================================================================
  # Testing, Schema, Docs, Smoke Tests
  # ==========================================================================
  - repo: local
    hooks:
      - id: gen-python
        name: gen-python (generate datamodel before tests)
        entry: uv run just gen-python
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push, manual]  # skip on commit, run on push or manual

      - id: pytest
        name: pytest (skip integration + MediaDive tests in CI)
        entry: uv run pytest -m 'not integration and not mediadive' --cov --cov-report=term-missing -q
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push, manual]  # skip on commit, run on push or manual

      - id: linkml-lint
        name: linkml-lint (schema validation)
        entry: uv run linkml-lint --config .linkml-lint.yaml src/cmm_ai_automation/schema/
        language: system
        pass_filenames: false
        always_run: true

      - id: mkdocs-build
        name: mkdocs build (documentation)
        entry: bash -c 'uv run gen-doc -d docs/elements src/cmm_ai_automation/schema/cmm_ai_automation.yaml && uv run mkdocs build --strict'
        language: system
        pass_filenames: false
        always_run: true

      - id: smoke-tests
        name: smoke tests (CLI verification)
        entry: bash -c 'uv run download-sheets --help > /dev/null && uv run enrich-ingredients --help > /dev/null && uv run enrich-to-store --help > /dev/null && uv run python -m cmm_ai_automation.scripts.codify_strains --help > /dev/null && uv run python -m cmm_ai_automation.scripts.build_ncbitaxon_chromadb --help > /dev/null && uv run python -m cmm_ai_automation.scripts.load_bacdive_mongodb --help > /dev/null && uv run python -m cmm_ai_automation.scripts.load_mediadive_details --help > /dev/null && uv run python -m cmm_ai_automation.scripts.strains_kgx_from_curies --help > /dev/null && uv run python -m cmm_ai_automation.scripts.chemicals_kgx_from_curies --help > /dev/null'
        language: system
        pass_filenames: false
        always_run: true
